FROM python:3.9-slim

# Set the environment variable for non-interactive installations
ENV DEBIAN_FRONTEND=noninteractive
ENV PATH="$PATH:/opt/mssql-tools/bin:/opt/mssql-tools18/bin"

# Install core dependencies including curl, unixodbc-dev, and the tools for GPG keys
RUN apt-get update && apt-get install -y \
    curl \
    gnupg \
    unixodbc-dev \
    apt-transport-https \
    build-essential \
    gcc \
    python3-dev \
    libssl-dev \
    libffi-dev \
    # Clean up apt caches to keep the image small
    && rm -rf /var/lib/apt/lists/*

# Add Microsoft's repository key using the secure 'signed-by' method
RUN curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /etc/apt/trusted.gpg.d/microsoft.gpg \
    && echo "deb [arch=amd64 signed-by=/etc/apt/trusted.gpg.d/microsoft.gpg] https://packages.microsoft.com/debian/11/prod bullseye main" > /etc/apt/sources.list.d/mssql-release.list

# Install mssql-tools18 and create compatibility symlink
RUN apt-get update && \
    ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev && \
    # Add both possible paths to PATH
    echo 'export PATH="$PATH:/opt/mssql-tools/bin:/opt/mssql-tools18/bin"' >> ~/.bashrc && \
    ln -sf /opt/mssql-tools/bin/sqlcmd /usr/bin/sqlcmd && \
    # Create compatibility symlink if 18 path doesn't exist
    mkdir -p /opt/mssql-tools18/bin && \
    ln -sf /opt/mssql-tools/bin/sqlcmd /opt/mssql-tools18/bin/sqlcmd && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Set the working directory
WORKDIR /app

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Copy the db-init script and make it executable
COPY db-init.sh /app/db-init.sh
RUN chmod +x /app/db-init.sh

# Expose port
EXPOSE 5000

# Command to run the application
CMD ["python", "app.py"]